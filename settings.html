<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Impostazioni JDM</title>
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;margin:20px;background:#0b0b10;color:#f5f5f5}
    h1,h2{margin-bottom:10px}
    input{padding:6px;border-radius:6px;border:1px solid #444;background:#15151c;color:#fff}
    button{margin-top:10px;padding:8px 16px;border-radius:6px;border:none;cursor:pointer;font-weight:600;background:#7f5bff;color:#fff}
    button:hover{filter:brightness(1.1)}
    table{width:100%;border-collapse:collapse;margin-top:15px;font-size:14px}
    th,td{border:1px solid #333;padding:6px 8px;text-align:left}
    th{background:#1f1f2b}
    tr:nth-child(even) td{background:#14141d}
    .info{margin-top:8px;font-size:13px;opacity:.85}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    hr{margin:28px 0;border-color:#222}
    a{color:#b88bff;text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>

<body>
  <h1>Impostazioni JDM</h1>
  <div class="info">
    Qui gestisci Dipendenti e Macchine. Tutto viene salvato in localStorage.
    <br>
    <a href="index.html">← Torna al fatturato</a>
  </div>

  <hr>

  <h2>Gestione dipendenti</h2>
  <div class="row">
    <input id="newDipendente" type="text" placeholder="Nome Cognome (es. Mario Rossi)" style="width:280px">
    <button onclick="addDipendente()">Aggiungi</button>
    <button onclick="resetDipendenti()" style="background:#ff4444;">Reset</button>
    <button onclick="exportDipendentiJson()">Export JSON</button>
    <button onclick="triggerImportDipendenti()">Import JSON</button>
    <input id="importDipFile" type="file" accept="application/json" style="display:none" />
  </div>

  <div class="info">Dipendenti salvati:</div>
  <div id="dipendentiList"></div>

  <hr>

  <h2>Gestione macchine</h2>
  <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:10px; margin-top:10px;">
    <input id="carModello" type="text" placeholder="Modello (es. ANNIS EUROS)">
    <input id="carCodice" type="text" placeholder="Codice (es. Euros)">
    <input id="carPrezzoVendita" type="text" placeholder="Prezzo vendita (es. 70000)">
    <input id="carPrezzoAcquisto" type="text" placeholder="Prezzo acquisto (es. 56000)">
    <input id="carProfitto" type="text" placeholder="Profitto (es. 13580)">
    <input id="carKeys" type="text" placeholder="Keys (virgola) es. euros, eu">
  </div>

  <div class="row">
    <button onclick="addCar()">Aggiungi macchina</button>
    <button onclick="resetCars()" style="background:#ff4444;">Reset</button>
    <button onclick="exportCarsJson()">Export JSON</button>
    <button onclick="triggerImportCars()">Import JSON</button>
    <input id="importCarsFile" type="file" accept="application/json" style="display:none" />
  </div>

  <div class="info">Macchine salvate:</div>
  <div id="carsList"></div>

<script>
  // ====== CHIAVI STORAGE (DEVONO MATCHARE index.html) ======
  const LS_DIP = "jdm_dipendenti";
  const LS_CARS = "jdm_autoList";

  // ====== DEFAULT (metti qui i tuoi default se vuoi) ======
  // Se vuoi i default originali: incolla gli array iniziali qui.
  const defaultDipendenti = [
        "Joe Pistone",
        "Carlos Santana",
        "Simone Garozzo",
        "Arianna Amato",
        "Antonio Ocristo",
        "Salvatore Riina",
        "Genny Esposito",
        "King Decali",
      ];
  const defaultAutoList = [
        {
          modello: "ANNIS CALICO GTF",
          codice: "CalicoGTF",
          prezzoVendita: 90000,
          prezzoAcquisto: 72000,
          profitto: 17460,
          keys: ["calico"],
        },
        {
          modello: "LA COUREUSE",
          codice: "LaCourese",
          prezzoVendita: 65400,
          prezzoAcquisto: 52320,
          profitto: 12687.6,
          keys: ["coureuse"],
        },
        {
          modello: "VAPID DOMINATOR ASP",
          codice: "DominatorASP",
          prezzoVendita: 52000,
          prezzoAcquisto: 41600,
          profitto: 10088,
          keys: ["dominator"],
        },
        {
          modello: "ELEGY RH8",
          codice: "ElegyRH8",
          prezzoVendita: 71000,
          prezzoAcquisto: 56800,
          profitto: 13774,
          keys: ["elegy", "rh8"],
        },
        {
          modello: "ANNIS EUROS",
          codice: "Euros",
          prezzoVendita: 70000,
          prezzoAcquisto: 56000,
          profitto: 13580,
          keys: ["euros"],
        },
        {
          modello: "FELON GT",
          codice: "FelonGT",
          prezzoVendita: 64500,
          prezzoAcquisto: 51600,
          profitto: 12513,
          keys: ["felon"],
        },
        {
          modello: "FLASH GT",
          codice: "FlashGT",
          prezzoVendita: 87000,
          prezzoAcquisto: 69600,
          profitto: 16878,
          keys: ["flash"],
        },
        {
          modello: "FATGOM FR36",
          codice: "FatgomFR36",
          prezzoVendita: 48000,
          prezzoAcquisto: 36000,
          profitto: 11640,
          keys: ["fatgom"],
        },
        {
          modello: "KARIN SKYLINE",
          codice: "KarinSkyline",
          prezzoVendita: 110000,
          prezzoAcquisto: 88000,
          profitto: 21340,
          keys: ["skyline"],
        },
        {
          modello: "MITSU EVO",
          codice: "Evo",
          prezzoVendita: 140000,
          prezzoAcquisto: 112000,
          profitto: 27160,
          keys: ["evo"],
        },
        {
          modello: "MIT GROWLER",
          codice: "Growler",
          prezzoVendita: 130000,
          prezzoAcquisto: 104000,
          profitto: 25220,
          keys: ["growler"],
        },
        {
          modello: "MIT HOTRING",
          codice: "Hotring",
          prezzoVendita: 145000,
          prezzoAcquisto: 116000,
          profitto: 28130,
          keys: ["hotring"],
        },
        {
          modello: "ISSI 8",
          codice: "Issi8",
          prezzoVendita: 33000,
          prezzoAcquisto: 26400,
          profitto: 6402,
          keys: ["issi"],
        },
        {
          modello: "JESTER RACE",
          codice: "JesterRace",
          prezzoVendita: 150000,
          prezzoAcquisto: 120000,
          profitto: 29100,
          keys: ["jester"],
        },
        {
          modello: "DINKA JASTER CLASSIC",
          codice: "JasterClassic",
          prezzoVendita: 80000,
          prezzoAcquisto: 64000,
          profitto: 15520,
          keys: ["jaster classic"],
        },
        {
          modello: "DINKA JASTER RR",
          codice: "JasterRR",
          prezzoVendita: 80000,
          prezzoAcquisto: 64000,
          profitto: 15520,
          keys: ["jaster rr"],
        },
        {
          modello: "DINKA KANJO SJ",
          codice: "KanjoSJ",
          prezzoVendita: 90000,
          prezzoAcquisto: 72000,
          profitto: 17460,
          keys: ["kanjo"],
        },
        {
          modello: "OBEY OMNIS",
          codice: "Omnis",
          prezzoVendita: 69000,
          prezzoAcquisto: 56800,
          profitto: 11834,
          keys: ["omnis"],
        },
        {
          modello: "VAN PARADISE",
          codice: "Paradise",
          prezzoVendita: 30000,
          prezzoAcquisto: 24000,
          profitto: 5820,
          keys: ["paradise"],
        },
        {
          modello: "PENUMBRA .",
          codice: "Penumbra.",
          prezzoVendita: 75000,
          prezzoAcquisto: 60000,
          profitto: 14550,
          keys: ["penumbra"],
        },
        {
          modello: "PENUMBRA FF",
          codice: "PenumbraFF",
          prezzoVendita: 60000,
          prezzoAcquisto: 48000,
          profitto: 11640,
          keys: ["penumbra ff", "penumbraff"],
        },
        {
          modello: "KARIN PREVION",
          codice: "Previon",
          prezzoVendita: 54000,
          prezzoAcquisto: 44800,
          profitto: 8924,
          keys: ["previon"],
        },
        {
          modello: "ANNIS REMUS",
          codice: "Remus",
          prezzoVendita: 60000,
          prezzoAcquisto: 48000,
          profitto: 11640,
          keys: ["remus"],
        },
        {
          modello: "RT 3000",
          codice: "RRRT3000",
          prezzoVendita: 49000,
          prezzoAcquisto: 39200,
          profitto: 9506,
          keys: ["rt3000", "rt 3000"],
        },
        {
          modello: "ETR 1",
          codice: "EETR1",
          prezzoVendita: 110000,
          prezzoAcquisto: 88000,
          profitto: 21340,
          keys: ["etr", "etr1"],
        },
        {
          modello: "SPECTER",
          codice: "SPECTER",
          prezzoVendita: 99000,
          prezzoAcquisto: 79200,
          profitto: 19206,
          keys: ["specter"],
        },
        {
          modello: "DINKA SUGOI",
          codice: "SUGOI",
          prezzoVendita: 90000,
          prezzoAcquisto: 72000,
          profitto: 17460,
          keys: ["sugoi"],
        },
        {
          modello: "KARIN SULTAN",
          codice: "SULTAN",
          prezzoVendita: 77000,
          prezzoAcquisto: 70400,
          profitto: 6402,
          keys: ["sultan "],
        },
        {
          modello: "SULTAN RS",
          codice: "SultanRS",
          prezzoVendita: 100000,
          prezzoAcquisto: 80000,
          profitto: 19400,
          keys: ["sultan rs"],
        },
        {
          modello: "ZION CABRIO",
          codice: "Cabrio",
          prezzoVendita: 53000,
          prezzoAcquisto: 42400,
          profitto: 10282,
          keys: ["zion", "cabrio"],
        },
        {
          modello: "ANNIS ZR350",
          codice: "ZZZR350",
          prezzoVendita: 60000,
          prezzoAcquisto: 48000,
          profitto: 11640,
          keys: ["zr350", "zr 350", "zr"],
        },
        {
          modello: "SULTAN 3",
          codice: "Sultan3",
          prezzoVendita: 65000,
          prezzoAcquisto: 52000,
          profitto: 12610,
          keys: ["sultan 3"],
        },
      ];

  // ====== UTILS ======
  function cleanString(t){
    return String(t||"").toLowerCase()
      .replace(/[^\w\sÀ-ÖØ-öø-ÿ]/g," ")
      .replace(/\s+/g," ")
      .trim();
  }
  function parseImporto(raw){
    if(!raw) return 0;
    let cleaned = String(raw).replace(/[^\d.,]/g,"").replace(/\./g,"").replace(",",".");
    return parseFloat(cleaned) || 0;
  }
  function downloadJson(filename, dataObj){
    const json = JSON.stringify(dataObj, null, 2);
    const blob = new Blob([json], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  // ====== DIPENDENTI ======
  let dipendenti = loadDipendenti();

  function loadDipendenti(){
    try{
      const v = JSON.parse(localStorage.getItem(LS_DIP));
      return Array.isArray(v) ? v : [...defaultDipendenti];
    } catch { return [...defaultDipendenti]; }
  }
  function saveDipendenti(arr){ localStorage.setItem(LS_DIP, JSON.stringify(arr)); }

  function renderDipendenti(){
    const wrap = document.getElementById("dipendentiList");
    if(dipendenti.length === 0){
      wrap.innerHTML = `<div class="info">Nessun dipendente.</div>`;
      return;
    }
    wrap.innerHTML = `
      <table><thead><tr><th>#</th><th>Nome</th><th>Azioni</th></tr></thead><tbody>
      ${dipendenti.map((d,i)=>`
        <tr>
          <td>${i+1}</td>
          <td>${d}</td>
          <td><button onclick="removeDipendente(${i})" style="background:#ff4444;padding:6px 10px;">Rimuovi</button></td>
        </tr>`).join("")}
      </tbody></table>`;
  }

  function addDipendente(){
    const input = document.getElementById("newDipendente");
    const raw = (input.value||"").trim();
    if(!raw) return;
    if(dipendenti.some(d => cleanString(d) === cleanString(raw))) { input.value=""; return; }
    dipendenti.push(raw);
    saveDipendenti(dipendenti);
    input.value = "";
    renderDipendenti();
  }
  function removeDipendente(idx){
    dipendenti.splice(idx,1);
    saveDipendenti(dipendenti);
    renderDipendenti();
  }
  function resetDipendenti(){
    if(!confirm("Reset dipendenti?")) return;
    dipendenti = [...defaultDipendenti];
    localStorage.removeItem(LS_DIP);
    saveDipendenti(dipendenti);
    renderDipendenti();
  }

  function exportDipendentiJson(){
    downloadJson("dipendenti_jdm.json", { version:1, exportedAt:new Date().toISOString(), dipendenti });
  }
  function triggerImportDipendenti(){
    const inp = document.getElementById("importDipFile");
    inp.value = "";
    inp.onchange = importDipendentiFromFile;
    inp.click();
  }
  function importDipendentiFromFile(e){
    const file = e.target.files?.[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const obj = JSON.parse(reader.result);
        let arr = Array.isArray(obj) ? obj : obj?.dipendenti;
        if(!Array.isArray(arr)) throw new Error("Formato non valido.");
        arr = arr.map(s=>String(s||"").trim()).filter(Boolean);

        const out=[]; const seen=new Set();
        arr.forEach(d=>{
          const k = cleanString(d);
          if(!seen.has(k)){ seen.add(k); out.push(d); }
        });

        dipendenti = out;
        saveDipendenti(dipendenti);
        renderDipendenti();
      } catch(err){
        alert("Import dipendenti fallito: " + err.message);
      }
    };
    reader.readAsText(file);
  }

  // ====== MACCHINE ======
  let autoList = loadCars();

  function loadCars(){
    try{
      const v = JSON.parse(localStorage.getItem(LS_CARS));
      return Array.isArray(v) ? v : [...defaultAutoList];
    } catch { return [...defaultAutoList]; }
  }
  function saveCars(arr){ localStorage.setItem(LS_CARS, JSON.stringify(arr)); }

  function renderCars(){
    const wrap = document.getElementById("carsList");
    if(autoList.length === 0){
      wrap.innerHTML = `<div class="info">Nessuna macchina.</div>`;
      return;
    }
    wrap.innerHTML = `
      <table>
        <thead><tr>
          <th>#</th><th>Modello</th><th>Codice</th><th>Vendita</th><th>Acquisto</th><th>Profitto</th><th>Keys</th><th>Azioni</th>
        </tr></thead>
        <tbody>
          ${autoList.map((a,i)=>`
            <tr>
              <td>${i+1}</td>
              <td>${a.modello||"-"}</td>
              <td>${a.codice||"-"}</td>
              <td>€ ${(a.prezzoVendita||0).toLocaleString("it-IT")}</td>
              <td>€ ${(a.prezzoAcquisto||0).toLocaleString("it-IT")}</td>
              <td>€ ${(a.profitto||0).toLocaleString("it-IT")}</td>
              <td>${Array.isArray(a.keys) ? a.keys.join(", ") : "-"}</td>
              <td><button onclick="removeCar(${i})" style="background:#ff4444;padding:6px 10px;">Rimuovi</button></td>
            </tr>`).join("")}
        </tbody>
      </table>`;
  }

  function addCar(){
    const modello = (document.getElementById("carModello").value||"").trim();
    const codice  = (document.getElementById("carCodice").value||"").trim();
    if(!modello || !codice) return;

    if(autoList.some(a => (a.codice||"").toLowerCase() === codice.toLowerCase())) return;

    const prezzoVendita = parseImporto(document.getElementById("carPrezzoVendita").value);
    const prezzoAcquisto = parseImporto(document.getElementById("carPrezzoAcquisto").value);
    const profitto = parseImporto(document.getElementById("carProfitto").value);

    const keysRaw = (document.getElementById("carKeys").value||"").trim();
    const keys = keysRaw ? keysRaw.split(",").map(s=>s.trim().toLowerCase()).filter(Boolean) : [];

    autoList.push({ modello, codice, prezzoVendita, prezzoAcquisto, profitto, keys });
    saveCars(autoList);

    ["carModello","carCodice","carPrezzoVendita","carPrezzoAcquisto","carProfitto","carKeys"]
      .forEach(id => document.getElementById(id).value = "");

    renderCars();
  }

  function removeCar(idx){
    autoList.splice(idx,1);
    saveCars(autoList);
    renderCars();
  }

  function resetCars(){
    if(!confirm("Reset macchine?")) return;
    autoList = [...defaultAutoList];
    localStorage.removeItem(LS_CARS);
    saveCars(autoList);
    renderCars();
  }

  function exportCarsJson(){
    downloadJson("macchine_jdm.json", { version:1, exportedAt:new Date().toISOString(), autoList });
  }
  function triggerImportCars(){
    const inp = document.getElementById("importCarsFile");
    inp.value = "";
    inp.onchange = importCarsFromFile;
    inp.click();
  }
  function importCarsFromFile(e){
    const file = e.target.files?.[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const obj = JSON.parse(reader.result);
        let arr = Array.isArray(obj) ? obj : obj?.autoList;
        if(!Array.isArray(arr)) throw new Error("Formato non valido.");

        const norm = arr.map(x=>{
          const modello = String(x?.modello||"").trim();
          const codice = String(x?.codice||"").trim();
          if(!modello || !codice) return null;

          let keys = x?.keys;
          if(typeof keys === "string") keys = keys.split(",").map(s=>s.trim().toLowerCase()).filter(Boolean);
          else if(Array.isArray(keys)) keys = keys.map(s=>String(s).trim().toLowerCase()).filter(Boolean);
          else keys = [];

          return {
            modello,
            codice,
            prezzoVendita: Number(x?.prezzoVendita)||0,
            prezzoAcquisto: Number(x?.prezzoAcquisto)||0,
            profitto: Number(x?.profitto)||0,
            keys
          };
        }).filter(Boolean);

        const out=[]; const seen=new Set();
        norm.forEach(a=>{
          const k = a.codice.toLowerCase();
          if(!seen.has(k)){ seen.add(k); out.push(a); }
        });

        autoList = out;
        saveCars(autoList);
        renderCars();
      } catch(err){
        alert("Import macchine fallito: " + err.message);
      }
    };
    reader.readAsText(file);
  }

  // ====== START ======
  window.addEventListener("load", () => {
    renderDipendenti();
    renderCars();
  });
</script>
</body>
</html>
